package main

import (
	"fmt"
	"os"
	"strings"
	"text/template"
)

type (
	TypeInfo struct {
		Name     string
		TypeName string
		ShowName string
	}
)

var header string = `// Generated by gen_types. Don't modify manually!

package core
`

var importFmt string = `
import (
	"fmt"
	"io"
)
`

var assertTemplate string = `
func Assert{{.Name}}(env *Env, obj Object, msg string) ({{.TypeName}}, error) {
	switch c := obj.(type) {
	case {{.TypeName}}:
		return c, nil
	default:
		if msg == "" {
			msg = fmt.Sprintf("Expected %s, got %s", "{{.ShowName}}", obj.GetType().Name())
		}
		var v {{.TypeName}}
		return v, env.RT.NewError(msg)
	}
}
`

var ensureTemplate string = `
func Ensure{{.Name}}(env *Env, args []Object, index int) ({{.TypeName}}, error) {
	if len(args) <= index {
		var t {{.TypeName}}
		return t, ErrorArity(env, index)
	}

	switch c := args[index].(type) {
	case {{.TypeName}}:
		return c, nil
	default:
		var v {{.TypeName}}
		return v, env.RT.NewArgTypeError(index, c, "{{.ShowName}}")
	}
}
`

var infoTemplate string = `
func (x {{.TypeName}}) WithInfo(info *ObjectInfo) Object {
	x.info = info
	return x
}
`

func checkError(err error) {
	if err != nil {
		panic(err)
	}
}

func generateAssertions(types []string) {
	filename := "types_assert_gen.go"
	f, err := os.Create(filename)
	checkError(err)
	defer f.Close()

	var assert = template.Must(template.New("assert").Parse(assertTemplate))
	var ensure = template.Must(template.New("ensure").Parse(ensureTemplate))
	_, _ = f.WriteString(header)
	_, _ = f.WriteString(importFmt)
	for _, t := range types {
		typeInfo := TypeInfo{
			Name:     t,
			TypeName: t,
			ShowName: t,
		}
		if t[0] == '*' {
			typeInfo.Name = t[1:]
			typeInfo.ShowName = typeInfo.Name
		} else if strings.ContainsRune(t, '.') {
			typeInfo.Name = strings.ReplaceAll(t, ".", "_")
		}
		err := assert.Execute(f, typeInfo)
		if err != nil {
			panic(err)
		}
		err = ensure.Execute(f, typeInfo)
		if err != nil {
			panic(err)
		}
	}
}

func generateInfo(types []string) {
	filename := "types_info_gen.go"
	f, err := os.Create(filename)
	checkError(err)
	defer f.Close()

	var info = template.Must(template.New("info").Parse(infoTemplate))

	_, _ = f.WriteString(header)
	for _, t := range types {
		typeInfo := TypeInfo{
			Name:     t,
			TypeName: t,
		}
		if t[0] == '*' {
			typeInfo.Name = t[1:]
		}
		err := info.Execute(f, typeInfo)
		if err != nil {
			panic(err)
		}
	}
}

func main() {
	cmd := os.Args[1]
	switch cmd {
	case "assert":
		generateAssertions(os.Args[2:])
	case "info":
		generateInfo(os.Args[2:])
	default:
		fmt.Println("Unknown command: ", cmd)
	}
}
